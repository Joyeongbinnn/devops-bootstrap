version: "3.8"

services:
  jenkins:
    build: ./jenkins        # 네가 만든 Dockerfile 그대로 사용
    container_name: jenkins
    user: "root"
    environment:
      # 서브도메인에서는 루트 경로로 운영 → prefix 불필요
      - JENKINS_OPTS=--prefix=/
      # 초기 마법사 생략 원하면 주석 해제
      # - JAVA_OPTS=-Djenkins.install.runSetupWizard=false
    volumes:
      - ./jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HOST_AWS_DIR:-$HOME/.aws}:/home/jenkins/.aws:ro
    restart: unless-stopped

  nginx:
    image: nginx:1.27-alpine
    container_name: jenkins-nginx
    depends_on: [jenkins]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certbot/www:/var/www/certbot
      - ./letsencrypt:/etc/letsencrypt
    restart: unless-stopped

  # 최초 인증서 발급 (1회성)
  certbot_init:
    image: certbot/certbot:latest
    container_name: certbot-init
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./letsencrypt:/etc/letsencrypt
    entrypoint: ["/bin/sh","-lc"]
    command: >
      "certbot certonly --webroot
       -w /var/www/certbot
       -d ${JENKINS_HOST}
       --agree-tos -m ${LE_EMAIL}
       --no-eff-email --non-interactive"

  # 자동 갱신(12h 주기) → 성공 시 Nginx reload
  certbot_renew:
    image: alpine:3.20
    container_name: certbot-renew
    depends_on: [nginx]
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./letsencrypt:/etc/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: ["/bin/sh","-lc"]
    command: >
      "apk add --no-cache certbot docker-cli &&
       while :; do
         certbot renew --webroot -w /var/www/certbot --quiet && \
         docker exec jenkins-nginx nginx -s reload || true;
         sleep 12h;
       done"
